<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DIPROCHIL - Detalle de Ruta</title>
  
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/responsive.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <style>
    /* Estilos para optimizaci√≥n */
    .optimization-section {
      background: #f9fafb;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .metric-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      text-align: center;
      border-left: 4px solid #2563eb;
    }

    .metric-card.savings {
      border-left-color: #10b981;
    }

    .metric-label {
      font-size: 13px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .metric-value {
      font-size: 32px;
      font-weight: 700;
      color: #111827;
    }

    .metric-value.savings {
      color: #10b981;
    }

    .metric-unit {
      font-size: 14px;
      color: #6b7280;
      margin-left: 4px;
    }

    .comparison-table {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .comparison-column {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .comparison-column h4 {
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e5e7eb;
    }

    .stop-item {
      padding: 12px;
      margin-bottom: 8px;
      background: #f9fafb;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .stop-order {
      background: #2563eb;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      margin-right: 12px;
    }

    #routeMap {
      height: 500px;
      border-radius: 8px;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <div class="app-container">

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <img src="assets/images/logo-diprochil.png" alt="DIPROCHIL">
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Principal</div>
          <a href="dashboard.html" class="nav-link">
            <span class="nav-link-icon">üìä</span>
            <span>Dashboard</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Gesti√≥n</div>
          <a href="clientes.html" class="nav-link">
            <span class="nav-link-icon">üë•</span>
            <span>Clientes</span>
          </a>
          <a href="pedidos.html" class="nav-link">
            <span class="nav-link-icon">üì¶</span>
            <span>Pedidos</span>
          </a>
          <a href="rutas.html" class="nav-link active">
            <span class="nav-link-icon">üöö</span>
            <span>Rutas</span>
          </a>
          <a href="vehiculos.html" class="nav-link">
            <span class="nav-link-icon">üöê</span>
            <span>Veh√≠culos</span>
          </a>
                  <a href="incidencias.html" class="nav-link">
          <span class="nav-link-icon">‚ö†Ô∏è</span>
          <span>Incidencias</span>
          </a>
</div>
      </nav>

      <div class="sidebar-footer">
        <button class="btn btn-danger btn-block btn-sm" id="logoutBtn">
          Cerrar Sesi√≥n
        </button>
      </div>
    </aside>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- MAIN CONTENT -->
    <main class="main-content">

      <header class="app-header">
        <div class="header-left">
          <button class="hamburger" id="hamburgerBtn">
            <span></span>
            <span></span>
            <span></span>
          </button>
          <h1 class="header-title" id="pageTitle">Detalle de Ruta</h1>
        </div>
        <div class="header-right">
          <div class="header-user">
            <div class="header-user-info">
              <div class="header-user-name" id="userName">Usuario</div>
              <div class="header-user-role" id="userRole">Rol</div>
            </div>
            <div class="header-user-avatar" id="userAvatar">U</div>
          </div>
        </div>
      </header>

      <div class="content-wrapper">

        <!-- BOT√ìN VOLVER -->
        <div class="mb-4">
          <a href="rutas.html" class="btn btn-secondary">‚Üê Volver a Rutas</a>
        </div>

        <!-- INFORMACI√ìN DE LA RUTA -->
        <div class="card" id="rutaInfo">
          <p class="text-center text-muted">Cargando informaci√≥n...</p>
        </div>

        <!-- RESUMEN -->
        <div class="grid grid-cols-4" id="rutaSummary" style="display: none;">
          <div class="card">
            <h3 class="text-muted text-sm mb-2">Total Paradas</h3>
            <div class="text-3xl font-bold" id="totalParadas">0</div>
          </div>
          <div class="card">
            <h3 class="text-muted text-sm mb-2">Pendientes</h3>
            <div class="text-3xl font-bold text-warning" id="paradasPendientes">0</div>
          </div>
          <div class="card">
            <h3 class="text-muted text-sm mb-2">Completadas</h3>
            <div class="text-3xl font-bold text-success" id="paradasCompletadas">0</div>
          </div>
          <div class="card">
            <h3 class="text-muted text-sm mb-2">Total Cajas</h3>
            <div class="text-3xl font-bold" id="totalCajas">0</div>
          </div>
        </div>

        <!-- MAPA DE LA RUTA -->
        <div class="card" id="mapCard" style="display: none;">
          <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <h2 class="card-title">üó∫Ô∏è Mapa de la Ruta</h2>
              <p class="card-subtitle">Visualiza el recorrido actual (y previsualiza el optimizado antes de aplicar)</p>
            </div>
            <span class="badge" id="mapViewLabel" style="background:#eef2ff; color:#1e40af; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:600;">
              Vista: Orden actual
            </span>
          </div>
          <div class="card-body">
            <div id="routeMapMessage" style="margin-bottom: 12px;"></div>
            <div id="routeMap"></div>
          </div>
        </div>

        <!-- SECCI√ìN DE OPTIMIZACI√ìN -->
        <div class="card" id="optimizationCard" style="display: none;">
          <div class="card-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h2 class="card-title">üöÄ Optimizaci√≥n de Ruta</h2>
                <p class="card-subtitle">Mejora el orden de entrega para ahorrar tiempo y combustible</p>
              </div>
              <button class="btn btn-success" id="btnOptimizar">
                üìä Optimizar Ruta
              </button>
            </div>
          </div>
          <div class="card-body">
            <div id="optimizationResults" style="display: none;">
              
              <!-- M√©tricas de Ahorro -->
              <div class="metrics-grid">
                <div class="metric-card">
                  <div class="metric-label">Distancia Total</div>
                  <div class="metric-value" id="metricDistance">--</div>
                  <span class="metric-unit">km</span>
                </div>
                <div class="metric-card">
                  <div class="metric-label">Tiempo Estimado</div>
                  <div class="metric-value" id="metricTime">--</div>
                  <span class="metric-unit">min</span>
                </div>
                <div class="metric-card">
                  <div class="metric-label">Combustible</div>
                  <div class="metric-value" id="metricFuel">--</div>
                  <span class="metric-unit">L</span>
                </div>
                <div class="metric-card savings">
                  <div class="metric-label">Ahorro Estimado</div>
                  <div class="metric-value savings" id="metricSavings">--</div>
                  <span class="metric-unit">CLP</span>
                </div>
              </div>

              <!-- Comparaci√≥n de √ìrdenes -->
              <div class="comparison-table">
                <div class="comparison-column">
                  <h4>üìã Orden Actual</h4>
                  <div id="currentOrderList"></div>
                </div>
                <div class="comparison-column">
                  <h4>‚ú® Orden Optimizado</h4>
                  <div id="optimizedOrderList"></div>
                </div>
              </div>

              <!-- Bot√≥n Aplicar -->
              <div style="margin-top: 24px; display:flex; gap: 12px; justify-content:center; flex-wrap: wrap;">
                <button class="btn btn-secondary" id="btnCancelarOptimizacion" style="padding: 12px 28px;">
                  ‚úï Cancelar
                </button>
                <button class="btn btn-warning" id="btnPrevisualizarOptimizacion" style="padding: 12px 28px;">
                  üëÅÔ∏è Previsualizar en mapa
                </button>
                <button class="btn btn-primary" id="btnAplicarOptimizacion" style="padding: 12px 48px;">
                  ‚úì Aplicar Orden Optimizado
                </button>
              </div>

            </div>
          </div>
        </div>

        <!-- PARADAS DE LA RUTA -->
        <div class="card">
          <div class="card-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h2 class="card-title">Paradas de la Ruta</h2>
                <p class="card-subtitle">Orden de entrega de pedidos</p>
              </div>
              <button class="btn btn-primary" id="btnAgregarParada">+ Agregar Parada</button>
            </div>
          </div>
          <div class="card-body">
            <div id="paradasTableContainer">
              <p class="text-center text-muted">Cargando paradas...</p>
            </div>
          </div>
        </div>

        <!-- SECCI√ìN DE INCIDENCIAS -->
        <div class="card" style="margin-top: 24px;">
          <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="font-size: 18px; font-weight: 600; margin: 0;">
              üö® Incidencias Reportadas
              <span id="incidenciasBadge" style="display: none; background: #ef4444; color: white; padding: 4px 10px; border-radius: 12px; font-size: 13px; margin-left: 8px;"></span>
            </h3>
          </div>
          <div class="card-body">
            <div id="incidenciasListContainer">
              <p class="text-muted text-center">Cargando incidencias...</p>
            </div>
          </div>
        </div>

      </div>

    </main>

  </div>

  <!-- MODAL: AGREGAR PARADA -->
  <div id="modalParada" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; padding: 20px; overflow-y: auto;">
    <div style="max-width: 700px; margin: 40px auto; background: white; border-radius: 12px; padding: 32px;">
      
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="font-size: 24px; font-weight: 600; margin: 0;">Agregar Parada</h2>
        <button id="btnCerrarModalParada" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>

      <div id="modalParadaMessage"></div>

      <form id="formParada">
        <div class="form-group">
          <label for="pedidoId" class="form-label required">Pedido a Agregar</label>
          <select id="pedidoId" class="form-select" required>
            <option value="">Seleccione un pedido pendiente...</option>
          </select>
          <span class="form-error"></span>
          <span class="form-help">Solo se muestran pedidos en estado PENDIENTE</span>
        </div>

        <div class="grid grid-cols-2">
          <div class="form-group">
            <label for="ordenVisita" class="form-label required">Orden de Visita</label>
            <input type="number" id="ordenVisita" class="form-input" min="1" required>
            <span class="form-error"></span>
          </div>

          <div class="form-group">
            <label for="horaEstimada" class="form-label">Hora Estimada</label>
            <input type="time" id="horaEstimada" class="form-input">
            <span class="form-error"></span>
          </div>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 24px;">
          <button type="button" class="btn btn-secondary" id="btnCancelarParada" style="flex: 1;">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary" id="btnGuardarParada" style="flex: 1;">
            Agregar Parada
          </button>
        </div>
      </form>

    </div>
  </div>

  <!-- JAVASCRIPT -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/ruta-detalle.js"></script>

  <script>
    Auth.requireAuth([CONFIG.ROLES.ADMIN, CONFIG.ROLES.PLANIFICADOR, CONFIG.ROLES.SUPERVISOR]);

    const user = Auth.getUser();
    document.getElementById('userName').textContent = user?.nombre || 'Usuario';
    document.getElementById('userRole').textContent = user?.role || 'Sin rol';
    document.getElementById('userAvatar').textContent = user?.nombre?.charAt(0).toUpperCase() || 'U';

    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    hamburgerBtn.addEventListener('click', () => {
      sidebar.classList.toggle('open');
      sidebarOverlay.classList.toggle('active');
      hamburgerBtn.classList.toggle('open');
    });

    sidebarOverlay.addEventListener('click', () => {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.remove('active');
      hamburgerBtn.classList.remove('open');
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      if (UI.confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
        Auth.logout();
      }
    });

    RutaDetalle.init();
  </script>

  <!-- MODAL: REPORTAR INCIDENCIA -->
  <div id="modalIncidencia" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; padding: 20px; overflow-y: auto;">
    <div style="max-width: 600px; margin: 40px auto; background: white; border-radius: 12px; padding: 32px;">
      
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="font-size: 24px; font-weight: 600; margin: 0;">üö® Reportar Incidencia</h2>
        <button onclick="RutaDetalle.cerrarModalIncidencia()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>

      <div style="background: #eff6ff; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
        <strong>Cliente:</strong> <span id="incidenciaCliente"></span>
      </div>

      <div id="modalIncidenciaMessage"></div>

      <form id="formIncidencia" onsubmit="event.preventDefault(); RutaDetalle.reportarIncidencia();">
        
        <input type="hidden" id="incidenciaParadaId">
        <input type="hidden" id="incidenciaPedidoId">

        <div class="form-group">
          <label for="incidenciaTipo" class="form-label required">Tipo de Incidencia</label>
          <select id="incidenciaTipo" class="form-select" required>
            <option value="">Seleccione...</option>
            <option value="CLIENTE_CERRADO">Cliente Cerrado</option>
            <option value="DIRECCION_INCORRECTA">Direcci√≥n Incorrecta</option>
            <option value="RECHAZO_PEDIDO">Rechazo del Pedido</option>
            <option value="PROBLEMA_VEHICULO">Problema con Veh√≠culo</option>
            <option value="ACCIDENTE_TRANSITO">Accidente de Tr√°nsito</option>
            <option value="CLIMA_ADVERSO">Clima Adverso</option>
            <option value="OTRO">Otro</option>
          </select>
        </div>

        <div class="form-group">
          <label for="incidenciaSeveridad" class="form-label required">Severidad</label>
          <select id="incidenciaSeveridad" class="form-select" required>
            <option value="BAJA">Baja</option>
            <option value="MEDIA" selected>Media</option>
            <option value="ALTA">Alta</option>
                      <option value="CRITICA">Cr√≠tica</option>
          </select>
        </div>

        <div class="form-group">
          <label for="incidenciaDescripcion" class="form-label required">Descripci√≥n</label>
          <textarea 
            id="incidenciaDescripcion" 
            class="form-input" 
            rows="4" 
            placeholder="Describe lo que sucedi√≥..."
            required
            style="resize: vertical;"
          ></textarea>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 24px;">
          <button type="button" class="btn btn-secondary" onclick="RutaDetalle.cerrarModalIncidencia()" style="flex: 1;">
            Cancelar
          </button>
          <button type="submit" class="btn btn-danger" id="btnGuardarIncidencia" style="flex: 1;">
            Reportar Incidencia
          </button>
        </div>
      </form>

    </div>
  </div>

</body>
</html>