<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Importar y Geocodificar - DIPROCHIL</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="js/config.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
    }

    h1 {
      color: #2563eb;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #6b7280;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .steps {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .step {
      background: #f9fafb;
      padding: 20px;
      border-radius: 12px;
      border: 2px solid #e5e7eb;
      text-align: center;
    }

    .step.active {
      border-color: #2563eb;
      background: #eff6ff;
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #2563eb;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 10px;
      font-weight: bold;
      font-size: 18px;
    }

    .step-title {
      font-weight: 600;
      margin-bottom: 5px;
      color: #374151;
    }

    .step-desc {
      font-size: 13px;
      color: #6b7280;
    }

    .section {
      background: #f9fafb;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 2px solid #e5e7eb;
    }

    .section h2 {
      color: #374151;
      margin-bottom: 20px;
      font-size: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
    }

    input[type="text"],
    input[type="email"],
    input[type="password"],
    select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #2563eb;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    input[type="file"] {
      display: none;
    }

    .file-input-label {
      display: block;
      padding: 40px;
      border: 3px dashed #cbd5e1;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
    }

    .file-input-label:hover {
      border-color: #2563eb;
      background: #eff6ff;
    }

    .file-input-label.has-file {
      border-color: #10b981;
      background: #ecfdf5;
    }

    .btn {
      padding: 14px 24px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      width: 100%;
    }

    .btn:hover:not(:disabled) {
      background: #1d4ed8;
    }

    .btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #6b7280;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #4b5563;
    }

    .preview-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      display: block;
    }

    .preview-table thead {
      background: #2563eb;
      color: white;
      position: sticky;
      top: 0;
    }

    .preview-table th,
    .preview-table td {
      padding: 12px;
      text-align: left;
      border: 1px solid #e5e7eb;
    }

    .preview-table tbody tr:hover {
      background: #f9fafb;
    }

    .log {
      background: #1f2937;
      color: #f9fafb;
      border-radius: 8px;
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      margin-top: 20px;
    }

    .log-line {
      padding: 4px 0;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .success { color: #10b981; }
    .error { color: #ef4444; }
    .info { color: #60a5fa; }
    .warning { color: #fbbf24; }

    .stats {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 15px;
      margin-top: 20px;
    }

    @media (max-width: 1100px) {
      .stats {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 640px) {
      .stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      border: 2px solid #e5e7eb;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #2563eb;
    }

    .stat-label {
      font-size: 12px;
      color: #6b7280;
      margin-top: 5px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid;
    }

    .alert-info {
      background: #eff6ff;
      border-color: #2563eb;
      color: #1e40af;
    }

    .alert-warning {
      background: #fffbeb;
      border-color: #f59e0b;
      color: #92400e;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>üìç Importar y Geocodificar Clientes</h1>
    <p class="subtitle">Carga el Excel con las direcciones y geocodifica autom√°ticamente</p>

    <!-- STEPS -->
    <div class="steps">
      <div class="step active" id="step1">
        <div class="step-number">1</div>
        <div class="step-title">Cargar Excel</div>
        <div class="step-desc">Sube el archivo con las direcciones</div>
      </div>
      <div class="step" id="step2">
        <div class="step-number">2</div>
        <div class="step-title">Mapear Columnas</div>
        <div class="step-desc">Indica qu√© columna es cada dato</div>
      </div>
      <div class="step" id="step3">
        <div class="step-number">3</div>
        <div class="step-title">Geocodificar</div>
        <div class="step-desc">Procesar direcciones</div>
      </div>
    </div>

    <!-- SECCI√ìN 1: CREDENCIALES -->
    <div class="section">
      <h2>üîê Credenciales de Administrador</h2>
      
      <div class="alert alert-warning">
        <strong>‚ö†Ô∏è Importante:</strong> Usa las credenciales de un usuario con rol ADMIN. Si no tienes usuario admin, cr√©alo primero en tu base de datos.
      </div>

      <div class="grid-2">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" placeholder="admin@diprochil.cl">
        </div>
        <div class="form-group">
          <label for="password">Contrase√±a</label>
          <input type="password" id="password" placeholder="Tu contrase√±a">
        </div>
      </div>

      <button class="btn btn-secondary" id="btnTestAuth">
        üîç Probar Autenticaci√≥n
      </button>
      <div id="authTestResult" style="margin-top: 15px;"></div>
    </div>

    <!-- SECCI√ìN 2: CARGAR EXCEL -->
    <div class="section">
      <h2>üìÅ Cargar Archivo Excel</h2>
      
      <div class="alert alert-info">
        <strong>üí° Formato esperado:</strong> El Excel debe tener columnas con: RUT, Raz√≥n Social, Direcci√≥n, Comuna, Ciudad, etc.
      </div>

      <div class="file-input-wrapper">
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">
        <label for="fileInput" class="file-input-label" id="fileLabel">
          <div style="font-size: 48px; margin-bottom: 10px;">üìÑ</div>
          <div style="font-weight: 600; font-size: 16px; margin-bottom: 5px;">
            Click para seleccionar archivo Excel
          </div>
          <div style="font-size: 13px; color: #6b7280;">
            Formatos aceptados: .xlsx, .xls, .csv
          </div>
        </label>
      </div>

      <div id="previewSection" style="display: none; margin-top: 30px;">
        <h3 style="margin-bottom: 15px; color: #374151;">Vista Previa de Datos</h3>
        <div id="previewContainer"></div>
      </div>
    </div>

    <!-- SECCI√ìN 3: MAPEAR COLUMNAS -->
    <div class="section" id="mappingSection" style="display: none;">
      <h2>üó∫Ô∏è Mapear Columnas del Excel</h2>
      
      <div class="alert alert-warning">
        <strong>‚ö†Ô∏è Importante:</strong> Indica qu√© columna de tu Excel corresponde a cada campo. La direcci√≥n es crucial para la geocodificaci√≥n.
      </div>

      <div class="grid-2">
        <div class="form-group">
          <label for="colRut">Columna RUT</label>
          <select id="colRut"></select>
        </div>
        <div class="form-group">
          <label for="colRazonSocial">Columna Raz√≥n Social</label>
          <select id="colRazonSocial"></select>
        </div>
        <div class="form-group">
          <label for="colDireccion">Columna Direcci√≥n <span style="color: #ef4444;">*</span></label>
          <select id="colDireccion"></select>
        </div>
        <div class="form-group">
          <label for="colComuna">Columna Comuna</label>
          <select id="colComuna"></select>
        </div>
        <div class="form-group">
          <label for="colCiudad">Columna Ciudad</label>
          <select id="colCiudad"></select>
        </div>
        <div class="form-group">
          <label for="colTelefono">Columna Tel√©fono (opcional)</label>
          <select id="colTelefono"></select>
        </div>
        <div class="form-group">
          <label for="colGiro">Columna Giro (opcional)</label>
          <select id="colGiro"></select>
        </div>
      </div>

      <button class="btn" id="btnProcesar">
        üöÄ Iniciar Actualizaci√≥n y Geocodificaci√≥n
      </button>
    </div>

    <!-- SECCI√ìN 4: PROGRESO -->
    <div class="section" id="progressSection" style="display: none;">
      <h2>‚öôÔ∏è Procesando...</h2>
      
      <div class="stats" id="stats">
        <div class="stat-card">
          <div class="stat-value" id="statNuevos">0</div>
          <div class="stat-label">Nuevos</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statActualizados">0</div>
          <div class="stat-label">Actualizados</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statSinCambios">0</div>
          <div class="stat-label">Sin cambios</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statDuplicados">0</div>
          <div class="stat-label">Duplicados Excel</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statGeocodificados">0</div>
          <div class="stat-label">Geocodificados</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="statErrores">0</div>
          <div class="stat-label">Errores</div>
        </div>
      </div>

      <div class="log" id="log"></div>

      <div id="summarySection" style="display:none; margin-top: 18px;"></div>
    </div>

  </div>

  <script>
    // ==================== CONFIGURACI√ìN ====================
   
    const GEO_CONFIG = {
  API_BASE: CONFIG.API_URL,
  ENDPOINTS: {
    LOGIN: CONFIG.ENDPOINTS.LOGIN,
    CLIENTS: CONFIG.ENDPOINTS.CLIENTS,
  },
};

    const API_BASE_URL = GEO_CONFIG.API_BASE;
    
    let excelData = [];
    let columnNames = [];
    let token = null;

    let stats = {
      total: 0,
      nuevos: 0,
      actualizados: 0,
      sinCambios: 0,
      duplicados: 0,
      geocodificados: 0,
      errores: 0,
    };

    // ==================== FUNCIONES DE LOG ====================

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const line = document.createElement('div');
      line.className = `log-line ${type}`;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(line);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function updateStats() {
      document.getElementById('statNuevos').textContent = stats.nuevos;
      document.getElementById('statActualizados').textContent = stats.actualizados;
      document.getElementById('statSinCambios').textContent = stats.sinCambios;
      document.getElementById('statDuplicados').textContent = stats.duplicados;
      document.getElementById('statGeocodificados').textContent = stats.geocodificados;
      document.getElementById('statErrores').textContent = stats.errores;
    }

    function renderSummary() {
      const wrap = document.getElementById('summarySection');
      wrap.style.display = 'block';

      wrap.innerHTML = `
        <div class="alert alert-info" style="background:#ecfdf5; border-color:#10b981; color:#065f46;">
          <div style="display:flex; align-items:center; gap:10px; margin-bottom: 10px;">
            <div style="font-size:22px;">‚úÖ</div>
            <div>
              <div style="font-weight:800; font-size:16px;">Proceso completado</div>
              <div style="font-size:13px; opacity:0.9;">Resumen de la actualizaci√≥n / creaci√≥n y geocodificaci√≥n</div>
            </div>
          </div>
          <div style="display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; font-size: 14px;">
            <div>üìÑ <strong>Total filas Excel:</strong> ${stats.total}</div>
            <div>üÜï <strong>Nuevos:</strong> ${stats.nuevos}</div>
            <div>‚úèÔ∏è <strong>Actualizados:</strong> ${stats.actualizados}</div>
            <div>‚è≠Ô∏è <strong>Sin cambios:</strong> ${stats.sinCambios}</div>
            <div>üßπ <strong>Duplicados (Excel):</strong> ${stats.duplicados}</div>
            <div>üìç <strong>Geocodificados:</strong> ${stats.geocodificados}</div>
            <div style="grid-column: 1 / -1;">‚ùå <strong>Errores:</strong> ${stats.errores}</div>
          </div>
          <div style="display:flex; gap: 12px; margin-top: 14px; flex-wrap: wrap;">
            <button class="btn" id="btnVolverClientes" style="width:auto;">üë• Volver a Clientes</button>
            <button class="btn btn-secondary" id="btnProcesarOtro" style="width:auto;">üìÑ Procesar otro Excel</button>
          </div>
        </div>
      `;

      document.getElementById('btnVolverClientes').addEventListener('click', () => {
        window.location.href = 'clientes.html';
      });
      document.getElementById('btnProcesarOtro').addEventListener('click', () => {
        window.location.reload();
      });
    }

    function setStep(stepNumber) {
      for (let i = 1; i <= 3; i++) {
        document.getElementById(`step${i}`).classList.remove('active');
      }
      document.getElementById(`step${stepNumber}`).classList.add('active');
    }

    // ==================== CARGAR Y LEER EXCEL ====================

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          // Nota: XLSX NO calcula f√≥rmulas. Pero al guardar normal en Excel,
          // el archivo suele incluir el resultado "cacheado" y eso s√≠ se puede leer.
          const workbook = XLSX.read(data, { type: 'array' });
          
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet, { defval: '', raw: false });
          
          if (jsonData.length === 0) {
            alert('El archivo est√° vac√≠o');
            return;
          }

          excelData = jsonData;
          columnNames = Object.keys(jsonData[0]);
          
          // Actualizar UI
          document.getElementById('fileLabel').classList.add('has-file');
          document.getElementById('fileLabel').innerHTML = `
            <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
            <div style="font-weight: 600; font-size: 16px; margin-bottom: 5px; color: #10b981;">
              Archivo cargado: ${file.name}
            </div>
            <div style="font-size: 13px; color: #6b7280;">
              ${excelData.length} registros encontrados
            </div>
          `;

          mostrarVistaPrevia();
          mostrarMapeoColumnas();
          setStep(2);

        } catch (error) {
          alert('Error al leer el archivo: ' + error.message);
          console.error(error);
        }
      };

      reader.readAsArrayBuffer(file);
    });

    function mostrarVistaPrevia() {
      const previewSection = document.getElementById('previewSection');
      const previewContainer = document.getElementById('previewContainer');
      
      previewSection.style.display = 'block';

      const preview = excelData.slice(0, 5); // Primeras 5 filas
      
      let html = '<table class="preview-table"><thead><tr>';
      columnNames.forEach(col => {
        html += `<th>${col}</th>`;
      });
      html += '</tr></thead><tbody>';
      
      preview.forEach(row => {
        html += '<tr>';
        columnNames.forEach(col => {
          html += `<td>${row[col] || '-'}</td>`;
        });
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      html += `<p style="margin-top: 10px; font-size: 13px; color: #6b7280;">Mostrando 5 de ${excelData.length} registros</p>`;
      
      previewContainer.innerHTML = html;
    }

    function mostrarMapeoColumnas() {
      const mappingSection = document.getElementById('mappingSection');
      mappingSection.style.display = 'block';

      // Llenar todos los selects
      const selects = ['colRut', 'colRazonSocial', 'colDireccion', 'colComuna', 'colCiudad', 'colTelefono', 'colGiro'];
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">-- Seleccionar columna --</option>';
        
        columnNames.forEach(col => {
          select.innerHTML += `<option value="${col}">${col}</option>`;
        });

        // Auto-detectar columnas comunes
        const autoDetect = {
          'colRut': ['rutcliente', 'rut', 'RUT', 'Rut'],
          'colRazonSocial': ['razonsocial', 'razon social', 'raz√≥n social', 'nombre', 'empresa', 'razonSocial'],
          'colDireccion': ['direccion', 'direcci√≥n', 'direccci√≥n', 'calle', 'domicilio'],
          'colComuna': ['comuna'],
          'colCiudad': ['ciudad'],
          'colTelefono': ['telefono', 'tel√©fono', 'fono', 'celular'],
          'colGiro': ['giro'],
        };

        const possibleMatches = autoDetect[selectId] || [];
        const match = columnNames.find(col => 
          possibleMatches.some(p => col.toLowerCase().includes(p.toLowerCase()))
        );

        if (match) {
          select.value = match;
        }
      });
    }

    // ==================== GEOCODIFICACI√ìN ====================

    async function geocodificarDireccion(direccion, comuna, ciudad, intentos = 3) {
      try {
        // Construir query de b√∫squeda
        const searchQuery = `${direccion}, ${comuna}, ${ciudad}, Chilo√©, Chile`;
        
        // Usar Nominatim (OpenStreetMap)
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=1`;
        
        const response = await fetch(url, {
          headers: {
            'User-Agent': 'DIPROCHIL-App/1.0'
          }
        });

        const data = await response.json();
        
        if (data && data.length > 0) {
          return {
            latitud: parseFloat(data[0].lat),
            longitud: parseFloat(data[0].lon),
            found: true
          };
        }

        // Si no encuentra, intentar solo con comuna
        const fallbackQuery = `${comuna}, Chilo√©, Chile`;
        const fallbackUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fallbackQuery)}&limit=1`;
        
        const fallbackResponse = await fetch(fallbackUrl, {
          headers: {
            'User-Agent': 'DIPROCHIL-App/1.0'
          }
        });

        const fallbackData = await fallbackResponse.json();
        
        if (fallbackData && fallbackData.length > 0) {
          // Agregar variaci√≥n aleatoria
          const latVariacion = (Math.random() - 0.5) * 0.01;
          const lngVariacion = (Math.random() - 0.5) * 0.01;
          
          return {
            latitud: parseFloat(fallbackData[0].lat) + latVariacion,
            longitud: parseFloat(fallbackData[0].lon) + lngVariacion,
            found: false // Indica que us√≥ fallback
          };
        }

        return null;

      } catch (error) {
        console.error('Error geocodificando:', error);
        
        // Si es error de red y quedan reintentos, intentar de nuevo
        if (error.message.includes('Failed to fetch') && intentos > 1) {
          log(`‚ö†Ô∏è  Error de red, reintentando... (${4 - intentos}/3)`, 'warning');
          await new Promise(resolve => setTimeout(resolve, 3000)); // Esperar 3 segundos
          return geocodificarDireccion(direccion, comuna, ciudad, intentos - 1);
        }
        
        return null;
      }
    }

    // ==================== AUTENTICACI√ìN Y API ====================

    async function obtenerToken() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;

      const loginUrl = GEO_CONFIG.API_BASE + GEO_CONFIG.ENDPOINTS.LOGIN;
      log(`üîó Intentando conectar a: ${loginUrl}`, 'info');

      try {
        const response = await fetch(loginUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        if (!response.ok) {
          if (response.status === 404) {
            throw new Error(`‚ùå Endpoint no encontrado: ${loginUrl}\n\nüí° Verifica la configuraci√≥n de rutas en el backend.`);
          }
          if (response.status === 401) {
            throw new Error(`Credenciales incorrectas\n\n Verifica:\n- Email: ${email}\n- Contrase√±a\n- Que el usuario exista en la base de datos\n- Que tenga rol ADMIN`);
          }
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || `Error ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        return data.token;
      } catch (error) {
        if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
          throw new Error(` No se puede conectar al servidor en ${GEO_CONFIG.API_BASE}\n\n Verifica que el backend est√© corriendo con: npm run dev`);
        }
        throw error;
      }
    }

    function normalizarRutKey(rut) {
      return String(rut ?? '')
        .trim()
        .toUpperCase()
        .replace(/\./g, '')
        .replace(/\s+/g, '')
        .replace(/-/g, '');
    }

    function cleanText(v) {
      const s = String(v ?? '').trim();
      return s.length ? s : '';
    }

    function isFormulaString(v) {
      const s = String(v ?? '').trim();
      return s.startsWith('=');
    }

    async function apiRequest(path, { method = 'GET', query = undefined, body = undefined } = {}) {
      const qs = query ? ('?' + new URLSearchParams(Object.entries(query).filter(([,v]) => v !== undefined && v !== null && v !== '')).toString()) : '';
      const url = GEO_CONFIG.API_BASE + path + qs;

      const headers = {};
      if (token) headers['Authorization'] = `Bearer ${token}`;
      if (body !== undefined) headers['Content-Type'] = 'application/json';

      const res = await fetch(url, {
        method,
        headers,
        ...(body !== undefined ? { body: JSON.stringify(body) } : {}),
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok || data?.ok === false) {
        const msg = data?.message || `Error ${res.status}: ${res.statusText}`;
        const err = new Error(msg);
        err.status = res.status;
        err.data = data;
        throw err;
      }
      return data;
    }

    async function fetchAllClientsMap() {
      const map = new Map();
      let skip = 0;
      const take = 1000;
      let total = Infinity;
      let rounds = 0;

      while (skip < total) {
        rounds++;
        const resp = await apiRequest(GEO_CONFIG.ENDPOINTS.CLIENTS, { query: { take, skip } });
        const items = resp.items || [];
        total = Number(resp.total ?? items.length);

        items.forEach((c) => {
          const key = normalizarRutKey(c.rut);
          if (key) map.set(key, c);
        });

        skip += take;

        // Seguridad: evitar loops infinitos si el backend no responde total
        if (rounds > 50) break;
        if (items.length < take && total === Infinity) break;
      }

      return map;
    }

    async function createClient(datos) {
      return apiRequest(GEO_CONFIG.ENDPOINTS.CLIENTS, { method: 'POST', body: datos });
    }

    async function patchClient(clienteId, datos) {
      return apiRequest(CONFIG.ENDPOINTS.CLIENTS + `/${clienteId}`, { method: 'PATCH', body: datos });
    }

    // ==================== PROCESAMIENTO PRINCIPAL ====================

    // ==================== PROCESAMIENTO PRINCIPAL ====================

    // Test de autenticaci√≥n
    document.getElementById('btnTestAuth').addEventListener('click', async function() {
      const btn = this;
      const resultDiv = document.getElementById('authTestResult');
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Probando...';
      resultDiv.innerHTML = '';

      try {
        const testToken = await obtenerToken();
        resultDiv.innerHTML = `
          <div class="alert alert-info" style="background: #ecfdf5; border-color: #10b981; color: #065f46;">
            ‚úÖ <strong>Autenticaci√≥n exitosa!</strong><br>
            Token obtenido correctamente. Puedes proceder a cargar el Excel.
          </div>
        `;
        btn.textContent = '‚úÖ Autenticaci√≥n OK';
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="alert alert-warning" style="background: #fef2f2; border-color: #ef4444; color: #991b1b;">
            ‚ùå <strong>Error de autenticaci√≥n</strong><br>
            ${error.message.replace(/\n/g, '<br>')}
          </div>
        `;
        btn.disabled = false;
        btn.textContent = 'üîç Probar Autenticaci√≥n';
      }
    });

    document.getElementById('btnProcesar').addEventListener('click', async function() {
      const btn = this;
      btn.disabled = true;
      btn.textContent = '‚è≥ Validando...';

      // Obtener mapeo de columnas
      const mapping = {
        rut: document.getElementById('colRut').value,
        razonSocial: document.getElementById('colRazonSocial').value,
        direccion: document.getElementById('colDireccion').value,
        comuna: document.getElementById('colComuna').value,
        ciudad: document.getElementById('colCiudad').value,
        telefono: document.getElementById('colTelefono').value,
        giro: document.getElementById('colGiro').value,
      };

      // Validar que al menos RUT, raz√≥n social y direcci√≥n est√©n mapeados
      if (!mapping.rut || !mapping.razonSocial || !mapping.direccion) {
        alert('Debes mapear al menos RUT, Raz√≥n Social y Direcci√≥n');
        btn.disabled = false;
        btn.textContent = 'üöÄ Iniciar Actualizaci√≥n y Geocodificaci√≥n';
        return;
      }

      // Mostrar secci√≥n de progreso
      document.getElementById('progressSection').style.display = 'block';
      setStep(3);

      // Reset stats
      stats = {
        total: excelData.length,
        nuevos: 0,
        actualizados: 0,
        sinCambios: 0,
        duplicados: 0,
        geocodificados: 0,
        errores: 0,
      };
      updateStats();

      try {
        log('üîë Conectando con el servidor...', 'info');
        log(`üì° API Base: ${GEO_CONFIG.API_BASE}`, 'info');
        log(`üîê Login: ${GEO_CONFIG.API_BASE + GEO_CONFIG.ENDPOINTS.LOGIN}`, 'info');
        log(`üìã Clientes: ${GEO_CONFIG.API_BASE + GEO_CONFIG.ENDPOINTS.CLIENTS}`, 'info');

        token = await obtenerToken();
        log('‚úÖ Autenticaci√≥n exitosa', 'success');

        log(`üìã Procesando ${excelData.length} registros...`, 'info');
        log('‚è±Ô∏è  Tiempo estimado: ' + Math.ceil(excelData.length * 1.2 / 60) + ' minutos', 'info');

        // Cargar clientes una sola vez (modo profesional)
        log('üì• Cargando clientes existentes (cache)...', 'info');
        const clientsMap = await fetchAllClientsMap();
        log(`‚úÖ Clientes cargados: ${clientsMap.size}`, 'success');

        // Detecci√≥n de duplicados en el Excel por RUT
        const seenRut = new Set();

        for (let i = 0; i < excelData.length; i++) {
          const row = excelData[i];
          
          try {
            const rut = cleanText(row[mapping.rut]);
            const razonSocial = cleanText(row[mapping.razonSocial]);
            const direccion = cleanText(row[mapping.direccion]);
            const comuna = cleanText(row[mapping.comuna]);
            const ciudad = cleanText(row[mapping.ciudad]);
            const telefono = cleanText(row[mapping.telefono]);
            const giro = cleanText(row[mapping.giro]);

            if (!rut || !razonSocial) {
              log(`‚ö†Ô∏è  Fila ${i + 1}: RUT o Raz√≥n Social vac√≠a - omitida`, 'warning');
              stats.errores++;
              updateStats();
              continue;
            }

            const rutKey = normalizarRutKey(rut);
            if (!rutKey) {
              log(`‚ö†Ô∏è  Fila ${i + 1}: RUT inv√°lido - omitida`, 'warning');
              stats.errores++;
              updateStats();
              continue;
            }

            // Duplicados dentro del Excel
            if (seenRut.has(rutKey)) {
              stats.duplicados++;
              updateStats();
              log(`üßπ Fila ${i + 1}: RUT repetido en el Excel (${rut}). Se omite para evitar duplicaci√≥n.`, 'warning');
              continue;
            }
            seenRut.add(rutKey);

            // Direcci√≥n con f√≥rmula sin resultado (caso raro)
            if (isFormulaString(direccion)) {
              log(`‚ö†Ô∏è  Fila ${i + 1}: La columna Direcci√≥n parece venir como f√≥rmula sin valor calculado. Revisa que el Excel est√© guardado con resultados.`, 'warning');
            }

            const existente = clientsMap.get(rutKey) || null;

            // Datos ‚Äúlimpios‚Äù desde Excel
            const excelPayload = {
              rut: rut, // se guarda con gui√≥n tal cual, el backend lo recorta
              razonSocial,
              comuna,
              ciudad,
              ...(direccion ? { direccion } : {}),
              ...(telefono ? { telefono } : {}),
              ...(giro ? { giro } : {}),
            };

            // Determinar si se necesita geocodificaci√≥n
            const needGeo = Boolean(
              direccion && comuna && (
                !existente ||
                !existente.latitud || !existente.longitud ||
                (cleanText(existente.direccion) !== direccion) ||
                (cleanText(existente.comuna) !== comuna) ||
                (cleanText(existente.ciudad) !== ciudad)
              )
            );

            let coordsToSave = null;
            if (needGeo) {
              log(`üìç [${i + 1}/${excelData.length}] Geocodificando: ${razonSocial}...`, 'info');
              coordsToSave = await geocodificarDireccion(direccion, comuna, ciudad || 'Chilo√©');

              if (coordsToSave) {
                if (coordsToSave.found) {
                  log(`‚úÖ ${razonSocial}: Direcci√≥n exacta encontrada`, 'success');
                } else {
                  log(`‚ö° ${razonSocial}: Ubicaci√≥n aproximada (centro de ${comuna})`, 'warning');
                }
                stats.geocodificados++;
                updateStats();
              } else {
                log(`‚ö†Ô∏è  ${razonSocial}: No se pudo geocodificar`, 'warning');
              }

              // Respetar l√≠mite de Nominatim (1 request/segundo) + margen
              await new Promise(resolve => setTimeout(resolve, 1300));
            }

            // Si existe: actualizar solo si cambi√≥ algo
            if (existente) {
              const diff = {};
              const compareFields = ['razonSocial', 'comuna', 'ciudad', 'direccion', 'telefono', 'giro'];
              compareFields.forEach((f) => {
                const newVal = cleanText(excelPayload[f]);
                if (!newVal) return;
                const oldVal = cleanText(existente[f]);
                if (newVal !== oldVal) diff[f] = newVal;
              });

              if (coordsToSave) {
                diff.latitud = coordsToSave.latitud;
                diff.longitud = coordsToSave.longitud;
              }

              const hasChanges = Object.keys(diff).length > 0;
              if (!hasChanges) {
                stats.sinCambios++;
                updateStats();
                log(`‚è≠Ô∏è  ${razonSocial} (${rut}): sin cambios`, 'info');
                continue;
              }

              await patchClient(existente.id, diff);
              stats.actualizados++;
              updateStats();
              log(`‚úèÔ∏è  ${i + 1}/${excelData.length} - ${razonSocial} actualizado`, 'success');

              // Mantener cache actualizado
              clientsMap.set(rutKey, { ...existente, ...diff });
              continue;
            }

            // Si NO existe: crear
            // Validar m√≠nimos del backend
            if (!excelPayload.comuna || !excelPayload.ciudad) {
              stats.errores++;
              updateStats();
              log(`‚ùå ${razonSocial} (${rut}): falta Comuna o Ciudad (requeridos).`, 'error');
              continue;
            }

            const createPayload = {
              rut: excelPayload.rut,
              razonSocial: excelPayload.razonSocial,
              comuna: excelPayload.comuna,
              ciudad: excelPayload.ciudad,
              ...(excelPayload.direccion ? { direccion: excelPayload.direccion } : {}),
              ...(excelPayload.telefono ? { telefono: excelPayload.telefono } : {}),
              ...(excelPayload.giro ? { giro: excelPayload.giro } : {}),
              ...(coordsToSave ? { latitud: coordsToSave.latitud, longitud: coordsToSave.longitud } : {}),
            };

            try {
              const created = await createClient(createPayload);
              stats.nuevos++;
              updateStats();
              log(`üÜï ${i + 1}/${excelData.length} - ${razonSocial} creado`, 'success');

              // Mantener cache actualizado
              const createdItem = created.item || created;
              if (createdItem?.rut) {
                clientsMap.set(rutKey, createdItem);
              }
            } catch (err) {
              // Conflicto por RUT √∫nico: tratar como existente y continuar
              if (err?.status === 409) {
                stats.duplicados++;
                updateStats();
                log(`üßπ ${razonSocial} (${rut}): ya existe (conflicto). Se omite creaci√≥n.`, 'warning');
              } else {
                throw err;
              }
            }

          } catch (error) {
            log(`‚ùå Error en fila ${i + 1}: ${error.message}`, 'error');
            stats.errores++;
            updateStats();
          }
        }

        log('\n' + '='.repeat(50), 'info');
        log('üìä PROCESO COMPLETADO', 'info');
        log(`üÜï Nuevos: ${stats.nuevos}`, 'success');
        log(`‚úèÔ∏è  Actualizados: ${stats.actualizados}`, 'success');
        log(`‚è≠Ô∏è  Sin cambios: ${stats.sinCambios}`, 'info');
        log(`üßπ Duplicados (Excel): ${stats.duplicados}`, 'warning');
        log(`üìç Geocodificados: ${stats.geocodificados}`, 'success');
        log(`‚ùå Errores: ${stats.errores}`, 'error');
        log('='.repeat(50), 'info');
        log('\nüí° SIGUIENTE PASO: Recarga la p√°gina de clientes para ver el mapa actualizado', 'info');

        renderSummary();

        btn.textContent = '‚úÖ Proceso Completado';

      } catch (error) {
        log(`‚ùå Error general: ${error.message}`, 'error');
        btn.disabled = false;
        btn.textContent = '‚ùå Error - Reintentar';
      }
    });
  </script>

</body>
</html>