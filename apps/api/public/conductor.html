<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DIPROCHIL - Panel del Conductor</title>

  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/components.css">
  <link rel="stylesheet" href="css/responsive.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    .dashboard-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 24px;
    }

    .welcome-section {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
      border-radius: 12px;
      padding: 32px;
      margin-bottom: 24px;
    }

    .welcome-section h1 {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .welcome-section p {
      opacity: 0.9;
      font-size: 16px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }

    .stat-card .icon {
      font-size: 40px;
      margin-bottom: 12px;
    }

    .stat-card .value {
      font-size: 32px;
      font-weight: 700;
      color: #111827;
    }

    .stat-card .label {
      font-size: 14px;
      color: #6b7280;
      margin-top: 4px;
    }

    .stat-card.primary { border-top: 4px solid #2563eb; }
    .stat-card.success { border-top: 4px solid #10b981; }
    .stat-card.warning { border-top: 4px solid #f59e0b; }
    .stat-card.danger { border-top: 4px solid #ef4444; }

    .ruta-resumen {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      background: #f9fafb;
      padding: 20px;
      border-radius: 8px;
      margin-top: 16px;
    }

    .ruta-resumen-item {
      text-align: center;
    }

    .ruta-resumen-item .label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .ruta-resumen-item .value {
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin-top: 4px;
    }

    .parada-card {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      border-left: 4px solid #2563eb;
    }

    .parada-card.completada {
      border-left-color: #10b981;
      opacity: 0.7;
    }

    .parada-card.no-entregada {
      border-left-color: #ef4444;
    }

    .parada-orden {
      background: #2563eb;
      color: white;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
    }

    .parada-card.completada .parada-orden { background: #10b981; }
    .parada-card.no-entregada .parada-orden { background: #ef4444; }

    .parada-acciones {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .empty-state {
      text-align: center;
      padding: 60px 24px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .empty-state .icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    #routeMap {
      height: 300px;
      border-radius: 8px;
      margin-top: 16px;
    }

    .quick-actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .ruta-toolbar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      padding: 16px;
      background: #f0f9ff;
      border-radius: 8px;
      border: 1px solid #bae6fd;
    }

    .ruta-toolbar .btn {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .edit-client-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      padding: 20px;
      overflow-y: auto;
    }

    .edit-client-modal-content {
      max-width: 500px;
      margin: 40px auto;
      background: white;
      border-radius: 12px;
      padding: 24px;
    }

    .coords-preview {
      background: #f9fafb;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      font-family: monospace;
      font-size: 13px;
    }
  </style>
</head>
<body>

  <div class="app-container">

    <!-- SIDEBAR PARA CONDUCTOR -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <img src="assets/images/logo-diprochil.png" alt="DIPROCHIL">
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Mi Panel</div>
          <a href="conductor.html" class="nav-link" id="navDashboard">
            <span class="nav-link-icon">üìä</span>
            <span>Dashboard</span>
          </a>
          <a href="conductor.html?vista=ruta" class="nav-link" id="navRuta">
            <span class="nav-link-icon">üöö</span>
            <span>Mi Ruta</span>
          </a>
          <a href="conductor.html?vista=incidencias" class="nav-link" id="navIncidencias">
            <span class="nav-link-icon">‚ö†Ô∏è</span>
            <span>Mis Incidencias</span>
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <button class="btn btn-danger btn-block btn-sm" id="logoutBtn">
          Cerrar Sesion
        </button>
      </div>
    </aside>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- MAIN CONTENT -->
    <main class="main-content">

      <header class="app-header">
        <div class="header-left">
          <button class="hamburger" id="hamburgerBtn">
            <span></span>
            <span></span>
            <span></span>
          </button>
          <h1 class="header-title" id="pageTitle">Panel del Conductor</h1>
        </div>
        <div class="header-right">
          <div class="header-user">
            <div class="header-user-info">
              <div class="header-user-name" id="userName">Conductor</div>
              <div class="header-user-role" id="userRole">CONDUCTOR</div>
            </div>
            <div class="header-user-avatar" id="userAvatar">C</div>
          </div>
        </div>
      </header>

      <div class="content-wrapper">
        <div id="contenidoPrincipal">
          <p class="text-center text-muted">Cargando...</p>
        </div>
      </div>

    </main>

  </div>

  <!-- MODAL: EDITAR CLIENTE (Georreferencia/Direccion) -->
  <div id="modalEditarCliente" class="edit-client-modal">
    <div class="edit-client-modal-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="font-size: 20px; font-weight: 600; margin: 0;">Corregir Ubicacion del Cliente</h2>
        <button onclick="Conductor.cerrarModalEditarCliente()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>

      <div style="background: #eff6ff; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
        <strong id="editClienteNombre">Cliente</strong>
        <div class="text-muted text-sm" id="editClienteDireccionActual"></div>
      </div>

      <div id="modalEditarClienteMessage"></div>

      <form id="formEditarCliente" onsubmit="event.preventDefault(); Conductor.guardarUbicacionCliente();">
        <input type="hidden" id="editClienteId">

        <div class="form-group">
          <label class="form-label">Direccion</label>
          <input type="text" id="editClienteDireccion" class="form-input" placeholder="Ej: Av. Principal 123">
        </div>

        <div class="form-group">
          <label class="form-label">Comuna</label>
          <input type="text" id="editClienteComuna" class="form-input" placeholder="Ej: Puerto Montt">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          <div class="form-group">
            <label class="form-label">Latitud</label>
            <input type="number" step="any" id="editClienteLatitud" class="form-input" placeholder="-41.4693">
          </div>
          <div class="form-group">
            <label class="form-label">Longitud</label>
            <input type="number" step="any" id="editClienteLongitud" class="form-input" placeholder="-72.9424">
          </div>
        </div>

        <button type="button" class="btn btn-secondary btn-block" onclick="Conductor.obtenerUbicacionActual()" style="margin-bottom: 12px;">
          Usar mi ubicacion actual
        </button>

        <div class="coords-preview" id="coordsPreview" style="display: none;">
          <strong>Vista previa:</strong>
          <div id="coordsPreviewText"></div>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button type="button" class="btn btn-secondary" onclick="Conductor.cerrarModalEditarCliente()" style="flex: 1;">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="btnGuardarCliente" style="flex: 1;">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL: REPORTAR INCIDENCIA -->
  <div id="modalIncidencia" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; padding: 20px; overflow-y: auto;">
    <div style="max-width: 600px; margin: 40px auto; background: white; border-radius: 12px; padding: 32px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h2 style="font-size: 24px; font-weight: 600; margin: 0;">Reportar Incidencia</h2>
        <button onclick="Conductor.cerrarModalIncidencia()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
      </div>

      <div style="background: #eff6ff; padding: 12px; border-radius: 8px; margin-bottom: 20px;">
        <strong>Cliente:</strong> <span id="incidenciaCliente"></span>
      </div>

      <div id="modalIncidenciaMessage"></div>

      <form id="formIncidencia" onsubmit="event.preventDefault(); Conductor.reportarIncidencia();">
        <input type="hidden" id="incidenciaParadaId">
        <input type="hidden" id="incidenciaPedidoId">

        <div class="form-group">
          <label for="incidenciaTipo" class="form-label required">Tipo de Incidencia</label>
          <select id="incidenciaTipo" class="form-select" required>
            <option value="">Seleccione...</option>
            <option value="CLIENTE_CERRADO">Cliente Cerrado</option>
            <option value="DIRECCION_INCORRECTA">Direccion Incorrecta</option>
            <option value="RECHAZO_PEDIDO">Rechazo del Pedido</option>
            <option value="PROBLEMA_VEHICULO">Problema con Vehiculo</option>
            <option value="ACCIDENTE_TRANSITO">Accidente de Transito</option>
            <option value="CLIMA_ADVERSO">Clima Adverso</option>
            <option value="OTRO">Otro</option>
          </select>
        </div>

        <div class="form-group">
          <label for="incidenciaDescripcion" class="form-label required">Descripcion</label>
          <textarea id="incidenciaDescripcion" class="form-input" rows="4" placeholder="Describe lo que sucedio..." required style="resize: vertical;"></textarea>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 24px;">
          <button type="button" class="btn btn-secondary" onclick="Conductor.cerrarModalIncidencia()" style="flex: 1;">Cancelar</button>
          <button type="submit" class="btn btn-danger" id="btnGuardarIncidencia" style="flex: 1;">Reportar Incidencia</button>
        </div>
      </form>
    </div>
  </div>

  <!-- JAVASCRIPT -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="js/config.js"></script>
  <script src="js/api.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/auth.js"></script>

  <script>
    Auth.requireAuth([CONFIG.ROLES.CONDUCTOR]);

    const user = Auth.getUser();
    document.getElementById('userName').textContent = user?.nombre || 'Conductor';
    document.getElementById('userRole').textContent = 'CONDUCTOR';
    document.getElementById('userAvatar').textContent = user?.nombre?.charAt(0).toUpperCase() || 'C';

    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    hamburgerBtn.addEventListener('click', () => {
      sidebar.classList.toggle('open');
      sidebarOverlay.classList.toggle('active');
      hamburgerBtn.classList.toggle('open');
    });

    sidebarOverlay.addEventListener('click', () => {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.remove('active');
      hamburgerBtn.classList.remove('open');
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      if (UI.confirm('Estas seguro de que deseas cerrar sesion?')) {
        Auth.logout();
      }
    });

    /* ========================================
       LOGICA DEL CONDUCTOR
       ======================================== */

    const Conductor = {
      ruta: null,
      incidencias: [],
      routeMap: null,
      vistaActual: 'dashboard',

      escapeHtml(str) {
        return String(str ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      },

      async init() {
        const params = new URLSearchParams(window.location.search);
        this.vistaActual = params.get('vista') || 'dashboard';

        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        if (this.vistaActual === 'ruta') {
          document.getElementById('navRuta').classList.add('active');
        } else if (this.vistaActual === 'incidencias') {
          document.getElementById('navIncidencias').classList.add('active');
        } else {
          document.getElementById('navDashboard').classList.add('active');
        }

        await this.cargarDatos();
        this.renderizarVista();
      },

      async cargarDatos() {
        try {
          const hoy = new Date();
          const year = hoy.getFullYear();
          const month = String(hoy.getMonth() + 1).padStart(2, '0');
          const day = String(hoy.getDate()).padStart(2, '0');
          const fechaHoy = `${year}-${month}-${day}`;

          console.log('üöö Conductor ID:', user?.id, '| Nombre:', user?.nombre);
          console.log('üöö Buscando rutas para fecha:', fechaHoy);

          const rutasRes = await API.get(`${CONFIG.ENDPOINTS.ROUTES}/my`, {
            date: fechaHoy,
          });

          console.log('üöö Rutas encontradas:', rutasRes.items?.length || 0);
          rutasRes.items?.forEach(r => console.log(`   - Ruta #${r.id}: ${r.zona}, estado=${r.estado}, conductorId=${r.conductorId}`));

          const rutas = rutasRes.items || [];

          const rutasActivas = rutas.filter(r => r.estado !== 'FINALIZADA' && r.estado !== 'CANCELADA');
          console.log('üöö Rutas activas (no finalizadas/canceladas):', rutasActivas.length);

          let rutaActiva = rutasActivas.find(r => r.estado === 'EN_CURSO');
          if (!rutaActiva) rutaActiva = rutasActivas.find(r => r.estado === 'PROGRAMADA');

          console.log('üöö Ruta activa seleccionada:', rutaActiva ? `#${rutaActiva.id} (${rutaActiva.estado})` : 'ninguna');

          if (rutaActiva) {
            const detalle = await API.get(`${CONFIG.ENDPOINTS.ROUTES}/${rutaActiva.id}/dashboard`);
            this.ruta = detalle.item;
            this.incidencias = detalle.item?.incidents || [];
            console.log('üöö Incidencias de esta ruta:', this.incidencias.length);
          } else {
            this.ruta = null;
            this.incidencias = [];
          }
        } catch (error) {
          console.error('Error al cargar datos:', error);
          this.ruta = null;
          this.incidencias = [];
        }
      },

      renderizarVista() {
        switch (this.vistaActual) {
          case 'ruta':
            document.getElementById('pageTitle').textContent = 'Mi Ruta';
            this.renderizarRuta();
            break;
          case 'incidencias':
            document.getElementById('pageTitle').textContent = 'Mis Incidencias';
            this.renderizarIncidencias();
            break;
          default:
            document.getElementById('pageTitle').textContent = 'Dashboard';
            this.renderizarDashboard();
        }
      },

      renderizarDashboard() {
        const container = document.getElementById('contenidoPrincipal');

        if (!this.ruta) {
          container.innerHTML = `
            <div class="welcome-section">
              <h1>Bienvenido, ${user?.nombre || 'Conductor'}</h1>
              <p>Panel de control del conductor - ${new Date().toLocaleDateString('es-CL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
            </div>
            <div class="empty-state">
              <div class="icon">üì≠</div>
              <h2>Sin ruta asignada</h2>
              <p>No tienes rutas programadas para hoy. Contacta a tu supervisor si crees que esto es un error.</p>
              <button class="btn btn-secondary" onclick="Conductor.cargarDatos().then(() => Conductor.renderizarVista())" style="margin-top: 16px;">
                Actualizar
              </button>
            </div>
          `;
          return;
        }

        const ruta = this.ruta;
        const paradas = ruta.stops || [];
        const totalParadas = paradas.length;
        const completadas = paradas.filter(p => p.estadoParada === 'COMPLETADA').length;
        const pendientes = paradas.filter(p => p.estadoParada === 'PENDIENTE').length;
        const noEntregadas = paradas.filter(p => p.estadoParada === 'NO_ENTREGADA').length;
        const totalCajas = paradas.reduce((sum, p) => sum + (p.pedido?.cajas || 0), 0);

        const estadoBadge = ruta.estado === 'EN_CURSO'
          ? '<span class="badge badge-warning" style="font-size: 14px; padding: 6px 12px;">EN CURSO</span>'
          : ruta.estado === 'PROGRAMADA'
            ? '<span class="badge badge-primary" style="font-size: 14px; padding: 6px 12px;">PROGRAMADA</span>'
            : '<span class="badge badge-success" style="font-size: 14px; padding: 6px 12px;">FINALIZADA</span>';

        container.innerHTML = `
          <div class="welcome-section">
            <h1>Bienvenido, ${user?.nombre || 'Conductor'}</h1>
            <p>${new Date().toLocaleDateString('es-CL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
          </div>

          <div class="stats-grid">
            <div class="stat-card primary">
              <div class="icon">üöö</div>
              <div class="value">${ruta.zona || '-'}</div>
              <div class="label">Zona Asignada</div>
            </div>
            <div class="stat-card success">
              <div class="icon">üì¶</div>
              <div class="value">${totalParadas}</div>
              <div class="label">Clientes / Pedidos</div>
            </div>
            <div class="stat-card warning">
              <div class="icon">üìã</div>
              <div class="value">${totalCajas}</div>
              <div class="label">Total Cajas</div>
            </div>
            <div class="stat-card ${noEntregadas > 0 ? 'danger' : 'primary'}">
              <div class="icon">‚ö†Ô∏è</div>
              <div class="value">${this.incidencias.length}</div>
              <div class="label">Incidencias Hoy</div>
            </div>
          </div>

          <div class="dashboard-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <div>
                <h2 style="font-size: 20px; font-weight: 600; margin: 0;">Ruta #${ruta.id}</h2>
                <p class="text-muted" style="margin-top: 4px;">Tu ruta asignada para hoy</p>
              </div>
              ${estadoBadge}
            </div>

            <div class="ruta-resumen">
              <div class="ruta-resumen-item">
                <div class="label">Vehiculo</div>
                <div class="value">${ruta.vehicle?.patente || '-'}</div>
              </div>
              <div class="ruta-resumen-item">
                <div class="label">Completadas</div>
                <div class="value" style="color: #10b981;">${completadas}</div>
              </div>
              <div class="ruta-resumen-item">
                <div class="label">Pendientes</div>
                <div class="value" style="color: #f59e0b;">${pendientes}</div>
              </div>
              <div class="ruta-resumen-item">
                <div class="label">No Entregadas</div>
                <div class="value" style="color: #ef4444;">${noEntregadas}</div>
              </div>
            </div>

            <div class="quick-actions">
              ${ruta.estado === 'PROGRAMADA' ? `
                <button class="btn btn-success" onclick="Conductor.iniciarRuta()">
                  Iniciar Ruta
                </button>
              ` : ruta.estado === 'EN_CURSO' ? `
                <button class="btn btn-primary" onclick="Conductor.finalizarRuta()">
                  Finalizar Ruta
                </button>
              ` : ''}
              <a href="conductor.html?vista=ruta" class="btn btn-secondary">
                Ver Detalle de Ruta
              </a>
            </div>
          </div>

          ${this.incidencias.length > 0 ? `
          <div class="dashboard-card">
            <h3 style="margin-bottom: 16px;">Incidencias Recientes</h3>
            ${this.incidencias.slice(0, 3).map(inc => `
              <div style="padding: 12px; background: #fef2f2; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #ef4444;">
                <strong>${this.escapeHtml(inc.tipo)}</strong>
                <p class="text-muted text-sm" style="margin-top: 4px;">${this.escapeHtml(inc.descripcion?.substring(0, 100))}...</p>
              </div>
            `).join('')}
            <a href="conductor.html?vista=incidencias" class="btn btn-outline" style="margin-top: 12px;">Ver todas</a>
          </div>
          ` : ''}
        `;
      },

      renderizarRuta() {
        const container = document.getElementById('contenidoPrincipal');

        if (!this.ruta) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">üì≠</div>
              <h2>Sin ruta asignada</h2>
              <p>No tienes rutas programadas para hoy.</p>
              <button class="btn btn-secondary" onclick="Conductor.cargarDatos().then(() => Conductor.renderizarVista())" style="margin-top: 16px;">Actualizar</button>
            </div>
          `;
          return;
        }

        const ruta = this.ruta;
        const paradas = ruta.stops || [];
        const totalParadas = paradas.length;
        const completadas = paradas.filter(p => p.estadoParada === 'COMPLETADA').length;
        const pendientes = paradas.filter(p => p.estadoParada === 'PENDIENTE').length;

        const estadoBadge = ruta.estado === 'EN_CURSO'
          ? '<span class="badge badge-warning">EN CURSO</span>'
          : '<span class="badge badge-primary">PROGRAMADA</span>';

        const botonesEstado = ruta.estado === 'PROGRAMADA'
          ? `<button class="btn btn-success" onclick="Conductor.iniciarRuta()">Iniciar Ruta</button>`
          : ruta.estado === 'EN_CURSO'
            ? `<button class="btn btn-primary" onclick="Conductor.finalizarRuta()">Finalizar Ruta</button>`
            : '';

        container.innerHTML = `
          <div class="dashboard-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
              <div>
                <span style="font-size: 24px; font-weight: 700;">Ruta #${ruta.id}</span>
                ${estadoBadge}
              </div>
              <div>${botonesEstado}</div>
            </div>

            <div class="ruta-resumen">
              <div class="ruta-resumen-item">
                <div class="label">Fecha</div>
                <div class="value">${UI.formatDate(ruta.fechaRuta)}</div>
              </div>
              <div class="ruta-resumen-item">
                <div class="label">Zona</div>
                <div class="value">${ruta.zona || '-'}</div>
              </div>
              <div class="ruta-resumen-item">
                <div class="label">Vehiculo</div>
                <div class="value">${ruta.vehicle?.patente || '-'}</div>
              </div>
              <div class="ruta-resumen-item">
                <div class="label">Total</div>
                <div class="value">${totalParadas}</div>
              </div>
              <div class="ruta-resumen-item">
                <div class="label">Completadas</div>
                <div class="value" style="color: #10b981;">${completadas}</div>
              </div>
              <div class="ruta-resumen-item">
                <div class="label">Pendientes</div>
                <div class="value" style="color: #f59e0b;">${pendientes}</div>
              </div>
            </div>

            <!-- Barra de herramientas de ruta -->
            <div class="ruta-toolbar">
              <button class="btn btn-primary" onclick="Conductor.optimizarRuta()" ${pendientes < 2 ? 'disabled' : ''}>
                <span>üó∫Ô∏è</span> Optimizar Ruta
              </button>
              <button class="btn btn-secondary" onclick="Conductor.cargarDatos().then(() => Conductor.renderizarVista())">
                <span>üîÑ</span> Actualizar
              </button>
            </div>

            <div id="routeMap"></div>
          </div>

          <div class="dashboard-card">
            <h3 style="margin-bottom: 16px; font-size: 18px;">Paradas (${totalParadas})</h3>
            ${paradas.length === 0
              ? '<p class="text-muted text-center">No hay paradas en esta ruta</p>'
              : paradas.sort((a, b) => a.ordenVisita - b.ordenVisita).map(parada => this.renderizarParada(parada)).join('')
            }
          </div>
        `;

        this.inicializarMapa();
      },

      renderizarParada(parada) {
        const estado = parada.estadoParada;
        let claseEstado = '';
        if (estado === 'COMPLETADA') claseEstado = 'completada';
        else if (estado === 'NO_ENTREGADA') claseEstado = 'no-entregada';

        const cliente = parada.pedido?.client;
        const direccionEscapada = this.escapeHtml(cliente ? `${cliente.direccion}, ${cliente.comuna}` : 'Direccion no disponible');
        const telefonoEscapado = this.escapeHtml(cliente?.telefono || '-');
        const cajas = parada.pedido?.cajas || 0;
        const clienteNombre = this.escapeHtml(cliente?.razonSocial || 'Cliente');
        const clienteIdSafe = parseInt(cliente?.id) || 0;

        const acciones = estado === 'PENDIENTE'
          ? `
            <div class="parada-acciones">
              <button class="btn btn-success btn-sm" onclick="Conductor.marcarEntregado(${parseInt(parada.id)})">‚úÖ Entregado</button>
              <button class="btn btn-secondary btn-sm" onclick="Conductor.abrirNavegacion(${parseInt(parada.id)})">üìç Navegar</button>
              <button class="btn btn-warning btn-sm" onclick="Conductor.abrirModalEditarCliente(${clienteIdSafe}, '${clienteNombre.replace(/'/g, "\\'")}')">‚úèÔ∏è Corregir</button>
              <button class="btn btn-danger btn-sm" onclick="Conductor.abrirModalIncidencia(${parseInt(parada.id)}, ${parseInt(parada.pedidoId)})">‚ö†Ô∏è Incidencia</button>
            </div>
          `
          : estado === 'COMPLETADA'
            ? '<div class="text-success text-sm" style="margin-top: 8px;">‚úÖ Entregado</div>'
            : '<div class="text-danger text-sm" style="margin-top: 8px;">‚ùå No entregado (incidencia reportada)</div>';

        return `
          <div class="parada-card ${claseEstado}">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <div class="parada-orden">${parada.ordenVisita}</div>
                <div>
                  <div style="font-weight: 600; font-size: 16px;">${clienteNombre}</div>
                  <div class="text-muted text-sm">${direccionEscapada}</div>
                </div>
              </div>
              <div style="text-align: right;">
                <div style="font-weight: 600;">${cajas} cajas</div>
                <div class="text-muted text-sm">Tel: ${telefonoEscapado}</div>
              </div>
            </div>
            ${acciones}
          </div>
        `;
      },

      renderizarIncidencias() {
        const container = document.getElementById('contenidoPrincipal');

        if (this.incidencias.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="icon">‚úÖ</div>
              <h2>Sin incidencias</h2>
              <p>No tienes incidencias reportadas hoy. Excelente trabajo!</p>
              <a href="conductor.html" class="btn btn-secondary" style="margin-top: 16px;">Volver al Dashboard</a>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="dashboard-card">
            <h2 style="margin-bottom: 20px;">Mis Incidencias de Hoy (${this.incidencias.length})</h2>

            ${this.incidencias.map(inc => {
              const estadoConfig = {
                'ABIERTA': { color: '#ef4444', bg: '#fef2f2', texto: 'Abierta' },
                'EN_REVISION': { color: '#f59e0b', bg: '#fffbeb', texto: 'En Revision' },
                'CERRADA': { color: '#10b981', bg: '#ecfdf5', texto: 'Cerrada' }
              }[inc.estado] || { color: '#6b7280', bg: '#f9fafb', texto: inc.estado };

              return `
                <div style="border-left: 4px solid ${estadoConfig.color}; padding: 16px; background: ${estadoConfig.bg}; border-radius: 8px; margin-bottom: 12px;">
                  <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                    <div>
                      <strong style="font-size: 15px;">${inc.tipo}</strong>
                      <span style="background: ${estadoConfig.color}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 8px;">
                        ${estadoConfig.texto}
                      </span>
                    </div>
                    <span style="color: #6b7280; font-size: 13px;">${UI.formatDate(inc.createdAt)}</span>
                  </div>
                  <p style="margin: 8px 0; color: #374151;">${inc.descripcion}</p>
                  ${inc.comentarioResolucion ? `
                  <div style="margin-top: 8px; padding: 8px; background: white; border-radius: 4px; font-size: 13px;">
                    <strong>Resolucion:</strong> ${inc.comentarioResolucion}
                  </div>
                  ` : ''}
                </div>
              `;
            }).join('')}

            <a href="conductor.html" class="btn btn-secondary" style="margin-top: 12px;">Volver al Dashboard</a>
          </div>
        `;
      },

      inicializarMapa() {
        const mapContainer = document.getElementById('routeMap');
        if (!mapContainer) return;

        const paradas = this.ruta?.stops || [];
        const markers = [];

        this.routeMap = L.map('routeMap').setView([-42.4696, -73.7711], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap'
        }).addTo(this.routeMap);

        paradas.forEach((parada) => {
          const lat = parada.pedido?.client?.latitud;
          const lng = parada.pedido?.client?.longitud;

          if (lat && lng) {
            const color = parada.estadoParada === 'COMPLETADA' ? '#10b981'
                        : parada.estadoParada === 'NO_ENTREGADA' ? '#ef4444'
                        : '#2563eb';

            L.marker([lat, lng], {
              icon: L.divIcon({
                className: 'custom-marker',
                html: `<div style="background: ${color}; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); font-size: 12px;">${parada.ordenVisita}</div>`,
                iconSize: [28, 28]
              })
            }).bindPopup(`
              <strong>${parada.pedido?.client?.razonSocial || 'Cliente'}</strong><br>
              ${parada.pedido?.cajas || 0} cajas
            `).addTo(this.routeMap);

            markers.push([lat, lng]);
          }
        });

        if (markers.length > 1) {
          L.polyline(markers, { color: '#2563eb', weight: 3, opacity: 0.7 }).addTo(this.routeMap);
        }

        if (markers.length > 0) {
          this.routeMap.fitBounds(markers, { padding: [30, 30] });
        }
      },

      async iniciarRuta() {
        if (!UI.confirm('Iniciar la ruta? Esto cambiara el estado a EN CURSO.')) return;
        try {
          await API.patch(`${CONFIG.ENDPOINTS.ROUTES}/${this.ruta.id}/status`, { estado: 'EN_CURSO' });
          UI.showAlert('Ruta iniciada correctamente', 'success');
          await this.cargarDatos();
          this.renderizarVista();
        } catch (error) {
          UI.showAlert(error.message || 'Error al iniciar la ruta', 'error');
        }
      },

      async finalizarRuta() {
        if (!UI.confirm('Finalizar la ruta? Asegurate de haber completado todas las entregas.')) return;
        try {
          await API.patch(`${CONFIG.ENDPOINTS.ROUTES}/${this.ruta.id}/status`, { estado: 'FINALIZADA' });
          UI.showAlert('Ruta finalizada correctamente', 'success');
          await this.cargarDatos();
          this.renderizarVista();
        } catch (error) {
          UI.showAlert(error.message || 'Error al finalizar la ruta', 'error');
        }
      },

      async marcarEntregado(paradaId) {
        if (!UI.confirm('Marcar esta parada como entregada?')) return;
        try {
          await API.patch(`${CONFIG.ENDPOINTS.ROUTES}/${this.ruta.id}/stops/${paradaId}`, { estadoParada: 'COMPLETADA' });
          UI.showAlert('Parada marcada como entregada', 'success');
          await this.cargarDatos();
          this.renderizarVista();
        } catch (error) {
          UI.showAlert(error.message || 'Error al actualizar la parada', 'error');
        }
      },

      abrirNavegacion(paradaId) {
        const parada = this.ruta?.stops?.find(p => p.id === paradaId);
        const client = parada?.pedido?.client;
        if (!client) {
          UI.showAlert('No se encontro la informacion del cliente', 'error');
          return;
        }

        let destination = '';
        if (client.latitud && client.longitud) {
          destination = `${client.latitud},${client.longitud}`;
        } else {
          const address = [client.direccion, client.comuna, client.ciudad, 'Chile'].filter(Boolean).join(', ');
          if (!address.trim()) {
            UI.showAlert('El cliente no tiene direccion ni coordenadas', 'error');
            return;
          }
          destination = address;
        }

        window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(destination)}&travelmode=driving`, '_blank');
      },

      abrirModalIncidencia(paradaId, pedidoId) {
        const parada = this.ruta.stops.find(s => s.id === paradaId);
        if (!parada) return;
        document.getElementById('incidenciaParadaId').value = paradaId;
        document.getElementById('incidenciaPedidoId').value = pedidoId;
        document.getElementById('incidenciaCliente').textContent = parada.pedido?.client?.razonSocial || 'Cliente';
        document.getElementById('modalIncidenciaMessage').innerHTML = '';
        document.getElementById('formIncidencia').reset();
        document.getElementById('modalIncidencia').style.display = 'block';
      },

      cerrarModalIncidencia() {
        document.getElementById('modalIncidencia').style.display = 'none';
      },

      async reportarIncidencia() {
        const paradaId = parseInt(document.getElementById('incidenciaParadaId').value);
        const tipo = document.getElementById('incidenciaTipo').value;
        const descripcion = document.getElementById('incidenciaDescripcion').value.trim();

        if (!tipo || !descripcion) {
          document.getElementById('modalIncidenciaMessage').innerHTML = '<div class="alert alert-danger">Completa todos los campos requeridos</div>';
          return;
        }

        const btnGuardar = document.getElementById('btnGuardarIncidencia');
        UI.setButtonLoading(btnGuardar, true);

        try {
          await API.patch(`${CONFIG.ENDPOINTS.ROUTES}/${this.ruta.id}/stops/${paradaId}`, {
            estadoParada: 'NO_ENTREGADA',
            incidente: { tipo, descripcion }
          });
          UI.showAlert('Incidencia reportada correctamente', 'success');
          this.cerrarModalIncidencia();
          await this.cargarDatos();
          this.renderizarVista();
        } catch (error) {
          document.getElementById('modalIncidenciaMessage').innerHTML = `<div class="alert alert-danger">${error.message || 'Error al reportar incidencia'}</div>`;
        } finally {
          UI.setButtonLoading(btnGuardar, false);
        }
      },

      async optimizarRuta() {
        if (!this.ruta || !this.ruta.stops) {
          UI.showAlert('No hay ruta cargada', 'error');
          return;
        }

        const paradasPendientes = this.ruta.stops.filter(p => p.estadoParada === 'PENDIENTE');

        if (paradasPendientes.length < 2) {
          UI.showAlert('Se necesitan al menos 2 paradas pendientes para optimizar', 'warning');
          return;
        }

        if (!UI.confirm(`Optimizar el orden de ${paradasPendientes.length} paradas pendientes? Esto reordenara la ruta para minimizar la distancia.`)) {
          return;
        }

        try {
          UI.showAlert('Optimizando ruta...', 'info');

          const pedidoIds = paradasPendientes.map(p => p.pedidoId);

          const resultado = await API.post(`${CONFIG.ENDPOINTS.ROUTES}/optimize`, {
            pedidoIds: pedidoIds
          });

          console.log('Resultado optimizacion:', resultado);

          if (!resultado.ok || !resultado.rutaOptimizada) {
            if (resultado.clientesSinCoordenadas) {
              const clientes = resultado.clientesSinCoordenadas.map(c => c.cliente).join(', ');
              throw new Error(`Clientes sin coordenadas: ${clientes}`);
            }
            throw new Error(resultado.message || 'No se pudo optimizar la ruta');
          }

          const puntosOptimizados = resultado.rutaOptimizada.puntos;

          for (let i = 0; i < puntosOptimizados.length; i++) {
            const pedidoId = puntosOptimizados[i].pedidoId;
            const parada = paradasPendientes.find(p => p.pedidoId === pedidoId);

            if (parada) {
              await API.patch(`${CONFIG.ENDPOINTS.ROUTES}/${this.ruta.id}/stops/${parada.id}`, {
                ordenVisita: i + 1
              });
            }
          }

          const distancia = resultado.rutaOptimizada.distanciaTotal?.toFixed(1) || '?';
          UI.showAlert(`Ruta optimizada! Distancia estimada: ${distancia} km`, 'success');

          await this.cargarDatos();
          this.renderizarVista();

        } catch (error) {
          console.error('Error al optimizar ruta:', error);
          UI.showAlert(error.message || 'Error al optimizar la ruta', 'error');
        }
      },

      abrirRutaCompleta() {
        if (!this.ruta || !this.ruta.stops) {
          UI.showAlert('No hay ruta cargada', 'error');
          return;
        }

        const paradasOrdenadas = this.ruta.stops
          .filter(p => p.estadoParada === 'PENDIENTE')
          .sort((a, b) => a.ordenVisita - b.ordenVisita);

        if (paradasOrdenadas.length === 0) {
          UI.showAlert('No hay paradas pendientes', 'warning');
          return;
        }

        const puntos = paradasOrdenadas.map(p => {
          const client = p.pedido?.client;
          if (client?.latitud && client?.longitud) {
            return `${client.latitud},${client.longitud}`;
          }
          return [client?.direccion, client?.comuna, 'Chile'].filter(Boolean).join(', ');
        }).filter(Boolean);

        if (puntos.length === 0) {
          UI.showAlert('No se encontraron direcciones validas', 'error');
          return;
        }

        let url = 'https://www.google.com/maps/dir/?api=1';
        url += `&origin=${encodeURIComponent(puntos[0])}`;
        url += `&destination=${encodeURIComponent(puntos[puntos.length - 1])}`;

        if (puntos.length > 2) {
          const waypoints = puntos.slice(1, -1).join('|');
          url += `&waypoints=${encodeURIComponent(waypoints)}`;
        }

        url += '&travelmode=driving';

        window.open(url, '_blank');
      },

      async abrirModalEditarCliente(clienteId, clienteNombre) {
        if (!clienteId) {
          UI.showAlert('Cliente no encontrado', 'error');
          return;
        }

        const parada = this.ruta?.stops?.find(p => p.pedido?.client?.id === clienteId);
        const cliente = parada?.pedido?.client;

        if (!cliente) {
          UI.showAlert('No se encontraron datos del cliente', 'error');
          return;
        }

        document.getElementById('editClienteId').value = clienteId;
        document.getElementById('editClienteNombre').textContent = cliente.razonSocial || clienteNombre;
        document.getElementById('editClienteDireccionActual').textContent =
          `Actual: ${cliente.direccion || '-'}, ${cliente.comuna || '-'}`;

        document.getElementById('editClienteDireccion').value = cliente.direccion || '';
        document.getElementById('editClienteComuna').value = cliente.comuna || '';
        document.getElementById('editClienteLatitud').value = cliente.latitud || '';
        document.getElementById('editClienteLongitud').value = cliente.longitud || '';

        document.getElementById('modalEditarClienteMessage').innerHTML = '';
        document.getElementById('coordsPreview').style.display = 'none';

        document.getElementById('modalEditarCliente').style.display = 'block';

        this.actualizarPreviewCoords();
      },

      cerrarModalEditarCliente() {
        document.getElementById('modalEditarCliente').style.display = 'none';
      },

      actualizarPreviewCoords() {
        const lat = document.getElementById('editClienteLatitud').value;
        const lng = document.getElementById('editClienteLongitud').value;
        const dir = document.getElementById('editClienteDireccion').value;
        const comuna = document.getElementById('editClienteComuna').value;

        const preview = document.getElementById('coordsPreview');
        const previewText = document.getElementById('coordsPreviewText');

        if (lat && lng) {
          preview.style.display = 'block';
          previewText.innerHTML = `
            <div>Lat: ${lat}, Lng: ${lng}</div>
            <div>${dir}, ${comuna}</div>
            <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" style="color: #2563eb;">Ver en Google Maps</a>
          `;
        } else if (dir) {
          preview.style.display = 'block';
          previewText.innerHTML = `<div>${dir}, ${comuna}</div>`;
        } else {
          preview.style.display = 'none';
        }
      },

      obtenerUbicacionActual() {
        if (!navigator.geolocation) {
          UI.showAlert('Tu navegador no soporta geolocalizacion', 'error');
          return;
        }

        UI.showAlert('Obteniendo ubicacion...', 'info');

        navigator.geolocation.getCurrentPosition(
          (position) => {
            document.getElementById('editClienteLatitud').value = position.coords.latitude.toFixed(6);
            document.getElementById('editClienteLongitud').value = position.coords.longitude.toFixed(6);
            this.actualizarPreviewCoords();
            UI.showAlert('Ubicacion obtenida correctamente', 'success');
          },
          (error) => {
            console.error('Error de geolocalizacion:', error);
            let mensaje = 'No se pudo obtener la ubicacion';
            if (error.code === 1) mensaje = 'Permiso de ubicacion denegado';
            if (error.code === 2) mensaje = 'Ubicacion no disponible';
            if (error.code === 3) mensaje = 'Tiempo de espera agotado';
            UI.showAlert(mensaje, 'error');
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      },

      async guardarUbicacionCliente() {
        const clienteId = parseInt(document.getElementById('editClienteId').value);
        const direccion = document.getElementById('editClienteDireccion').value.trim();
        const comuna = document.getElementById('editClienteComuna').value.trim();
        const latitud = parseFloat(document.getElementById('editClienteLatitud').value) || null;
        const longitud = parseFloat(document.getElementById('editClienteLongitud').value) || null;

        if (!direccion && !latitud) {
          document.getElementById('modalEditarClienteMessage').innerHTML =
            '<div class="alert alert-danger">Ingresa al menos una direccion o coordenadas</div>';
          return;
        }

        const btnGuardar = document.getElementById('btnGuardarCliente');
        UI.setButtonLoading(btnGuardar, true);

        try {
          await API.patch(`${CONFIG.ENDPOINTS.CLIENTS}/${clienteId}`, {
            direccion,
            comuna,
            latitud,
            longitud
          });

          UI.showAlert('Ubicacion del cliente actualizada correctamente', 'success');
          this.cerrarModalEditarCliente();

          await this.cargarDatos();
          this.renderizarVista();

        } catch (error) {
          console.error('Error al guardar cliente:', error);
          document.getElementById('modalEditarClienteMessage').innerHTML =
            `<div class="alert alert-danger">${error.message || 'Error al guardar los cambios'}</div>`;
        } finally {
          UI.setButtonLoading(btnGuardar, false);
        }
      }
    };

    ['editClienteLatitud', 'editClienteLongitud', 'editClienteDireccion', 'editClienteComuna'].forEach(id => {
      document.getElementById(id)?.addEventListener('input', () => Conductor.actualizarPreviewCoords());
    });

    Conductor.init();
  </script>

</body>
</html>
